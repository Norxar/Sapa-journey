<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SAPA JOURNEY â€” Match-3 (8x8)</title>
<style>
  :root {
    --cell-size: 56px;
    --gap: 6px;
    --bg: #0f1220;
    --panel: #1a1f3b;
    --accent: #6272ff;
    --text: #e9ecff;
    --muted: #b4b9d6;
    --highlight: #ffd166;
    --danger: #ff6b6b;
  }
  html, body {
    height: 100%;
  }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 800px at 70% -10%, #1f2650 0%, #0b0e1d 60%, #070914 100%);
    color: var(--text);
    display: grid;
    place-items: center;
  }
  .wrapper {
    width: min(92vw, 720px);
    display: grid;
    gap: 16px;
  }
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: color-mix(in oklab, var(--panel) 90%, black 10%);
    border: 1px solid color-mix(in oklab, var(--panel), white 10%);
    border-radius: 14px;
    padding: 12px 14px;
    box-shadow: 0 6px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  }
  .title {
    display: grid;
    gap: 4px;
  }
  .title h1 {
    margin: 0;
    font-size: 16px;
    letter-spacing: 0.3px;
  }
  .title .sub {
    font-size: 12px;
    color: var(--muted);
  }
  .stats {
    display: flex;
    gap: 14px;
    align-items: center;
    font-size: 13px;
  }
  .stat {
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.07);
    border-radius: 10px;
    padding: 6px 10px;
  }
  .btn {
    appearance: none;
    border: none;
    background: linear-gradient(180deg, #7b86ff 0%, #5763ff 100%);
    color: white;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 700;
    box-shadow: 0 8px 18px rgba(98,114,255,.35), inset 0 1px 0 rgba(255,255,255,.3);
    cursor: pointer;
    transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:active {
    transform: translateY(1px);
    box-shadow: 0 4px 12px rgba(98,114,255,.28), inset 0 1px 0 rgba(255,255,255,.25);
  }
  .btn.secondary {
    background: linear-gradient(180deg, #3a3f72 0%, #2a2f5a 100%);
    color: #e3e6ff;
  }
  .btn.superpower {
    background: linear-gradient(180deg, #ff6b35 0%, #e55a2b 100%);
    color: white;
    box-shadow: 0 8px 18px rgba(255,107,53,.35), inset 0 1px 0 rgba(255,255,255,.3);
    padding: 14px 18px;
    font-size: 16px;
  }
  .btn.superpower:active {
    box-shadow: 0 4px 12px rgba(255,107,53,.28), inset 0 1px 0 rgba(255,255,255,.25);
  }
  .btn.superpower img {
    width: 32px;
    height: 32px;
    object-fit: contain;
    pointer-events: none;
  }
  /* Life hearts */
  .lives {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .heart {
    width: 20px;
    height: 20px;
    color: var(--danger);
    transition: color .3s ease;
    font-size: 18px;
    font-weight: bold;
  }
  .heart.lost {
    color: #444;
  }
  /* Defeat overlay */
  .defeat-overlay {
    position: fixed;
    inset: 0;
    display: none;
    place-items: center;
    background: rgba(0,0,0,.85);
    backdrop-filter: blur(4px);
    z-index: 2000;
  }
  .defeat-overlay.show { display: grid; }
  .defeat-content {
    text-align: center;
    color: var(--text);
  }
  .defeat-content h2 {
    margin: 0 0 16px 0;
    font-size: 28px;
    color: var(--danger);
  }
  .defeat-content p {
    margin: 0 0 20px 0;
    color: var(--muted);
    font-size: 16px;
  }
     .defeat-gif {
     max-width: min(80vw, 400px);
     max-height: min(60vh, 300px);
     border-radius: 12px;
     margin-bottom: 20px;
   }
   
   /* Time-up overlay */
   .time-up-overlay {
     position: fixed;
     inset: 0;
     display: none;
     place-items: center;
     background: rgba(0,0,0,.85);
     backdrop-filter: blur(4px);
     z-index: 2000;
   }
   .time-up-overlay.show { display: grid; }
   .time-up-content {
     text-align: center;
     color: var(--text);
   }
   .time-up-content h2 {
     margin: 0 0 16px 0;
     font-size: 28px;
     color: var(--highlight);
   }
   .time-up-content p {
     margin: 0 0 20px 0;
     color: var(--muted);
     font-size: 16px;
   }
   .time-up-content #finalScore {
     color: var(--highlight);
     font-weight: bold;
     font-size: 18px;
   }
  .board-wrap {
    display: none; /* shown after Start */
    background: color-mix(in oklab, var(--panel) 88%, black 12%);
    border: 1px solid color-mix(in oklab, var(--panel), white 10%);
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 10px 32px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
    position: relative; /* for effects overlay */
  }
  .legend {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
    color: var(--muted);
    font-size: 13px;
    flex-wrap: wrap;
  }
  .legend .pill {
    display: inline-flex;
    gap: 6px;
    align-items: center;
    padding: 6px 10px;
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.07);
    border-radius: 999px;
  }
  .board {
    display: grid;
    grid-template-columns: repeat(8, var(--cell-size));
    grid-auto-rows: var(--cell-size);
    gap: var(--gap);
    justify-content: center;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
  }
  .cell {
    width: var(--cell-size);
    height: var(--cell-size);
    display: grid;
    place-items: center;
    font-size: 30px;
    background: linear-gradient(180deg,#1b2040,#141935);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 12px;
    cursor: pointer;
    transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
    box-shadow: 0 4px 14px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.06);
  }
  .cell:hover { background: linear-gradient(180deg,#222750,#171c3a); }
  .cell.selected {
    outline: 2px solid var(--highlight);
    outline-offset: 2px;
    box-shadow: 0 0 0 2px var(--highlight), 0 8px 22px rgba(255,209,102,.25);
    transform: translateY(-2px);
  }
  .cell.busy {
    filter: saturate(.9) brightness(.9);
    cursor: default;
  }
  .cell.matched {
    animation: pop .22s ease forwards;
    background: linear-gradient(180deg, #2b2140, #261a3a);
    box-shadow: 0 0 0 2px #ffd16655, 0 0 18px #ffd16633 inset;
  }
  .cell.invalid {
    outline: 2px solid var(--danger);
    outline-offset: 2px;
    box-shadow: 0 0 0 2px var(--danger), 0 8px 18px rgba(255,107,107,.25);
    animation: wiggle .16s ease;
  }
  @keyframes pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(0.9); filter: brightness(1.2); }
  }
  @keyframes wiggle {
    0% { transform: translateX(0); }
    50% { transform: translateX(2px); }
    100% { transform: translateX(0); }
  }
     .cell .icon { 
     width: 70%; 
     height: 70%; 
     object-fit: contain; 
     pointer-events: none;
     border-radius: 8px;
   }
   .legend .icon { width: 18px; height: 18px; object-fit: contain; }
   
   /* Tile outlines for each symbol */
   .cell[data-symbol="fujky"] .icon {
     outline: 2px solid white;
     outline-offset: -2px;
   }
   .cell[data-symbol="hauky"] .icon {
     outline: 2px solid #ff6b6b;
     outline-offset: -2px;
   }
   .cell[data-symbol="kaja"] .icon {
     outline: 2px solid #4ecdc4;
     outline-offset: -2px;
   }
   .cell[data-symbol="luky"] .icon {
     outline: 2px solid #45b7d1;
     outline-offset: -2px;
   }
       .cell[data-symbol="martin"] .icon {
      outline: 2px solid #ffa726;
      outline-offset: -2px;
    }
    .cell[data-symbol="lightning"] .icon {
      outline: 2px solid #ffeb3b;
      outline-offset: -2px;
    }
    .cell[data-symbol="tree"] .icon {
      outline: 2px solid #8bc34a;
      outline-offset: -2px;
    }

  .footer {
    margin-top: 10px;
    color: var(--muted);
    font-size: 12px;
    text-align: center;
  }
  /* Visual effects */
  .fx-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 5;
    overflow: visible;
  }
  .fx-text {
    position: absolute;
    left: 50%;
    top: 16%;
    transform: translate(-50%, -50%);
    font-weight: 900;
    letter-spacing: 1px;
    text-shadow: 0 4px 16px rgba(0,0,0,.45);
    opacity: 0;
    animation: fx-pop 750ms ease forwards;
    will-change: transform, opacity;
  }
  .fx-text.small { font-size: 20px; }
  .fx-text.large { font-size: 34px; }
  .fx-text.tadaa { color: var(--highlight); }
     .fx-text.mnam { color: #79ffa1; }
   
  @keyframes fx-pop {
    0% { opacity: 0; transform: translate(-50%, -40%) scale(.9); }
    30% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
    60% { opacity: 1; transform: translate(-50%, -56%) scale(1.0); }
    100% { opacity: 0; transform: translate(-50%, -68%) scale(.96); }
  }
  /* Radost overlay for 4+ matches */
  .radost-overlay {
    position: absolute;
    inset: 0;
    display: none;
    place-items: center;
    pointer-events: none;
    z-index: 8;
  }
  .radost-overlay.show { display: grid; }
  .radost-overlay::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 16px;
    border: 3px solid rgba(255,214,102,.85);
    box-shadow: 0 0 24px rgba(255,214,102,.45), 0 0 96px 24px rgba(255,214,102,.25);
    opacity: 0;
    animation: radost-ring 1000ms ease-in-out forwards;
  }
  .radost-img {
    max-width: min(60vw, 360px);
    max-height: min(60vh, 360px);
    border-radius: 14px;
    outline: 3px solid rgba(255, 255, 255, 0.85);
    box-shadow: 0 0 24px 8px rgba(255, 214, 102, 0.35), 0 0 64px 24px rgba(255, 214, 102, 0.2);
    animation: radost-glow 3000ms ease-in-out forwards;
  }
  @keyframes radost-glow {
    0% { box-shadow: 0 0 8px 2px rgba(255,214,102,.25), 0 0 24px 8px rgba(255,214,102,.15); opacity: 0; transform: scale(.96); }
    20% { opacity: 1; transform: scale(1.02); }
    50% { box-shadow: 0 0 32px 16px rgba(255,214,102,.45), 0 0 120px 48px rgba(255,214,102,.25); }
    100% { box-shadow: 0 0 22px 10px rgba(255,214,102,.35), 0 0 90px 36px rgba(255,214,102,.22); opacity: 0; transform: scale(1.00); }
  }
  @keyframes radost-ring {
    0% { opacity: 0; transform: scale(.98); }
    20% { opacity: 1; transform: scale(1.00); }
    80% { opacity: 1; }
    100% { opacity: 0; transform: scale(1.00); }
  }
  /* One-click Play overlay */
  .overlay {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    background: radial-gradient(1200px 800px at 70% -10%, rgba(31,38,80,.85) 0%, rgba(11,14,29,.85) 60%, rgba(7,9,20,.9) 100%);
    backdrop-filter: blur(2px);
    z-index: 1000;
  }
  .overlay.hidden { display: none; }
  .overlay .cta { display: grid; gap: 12px; text-align: center; }
  .overlay h2 { margin: 0; font-size: 22px; letter-spacing: .5px; }
  .overlay p { margin: 0; color: var(--muted); font-size: 13px; }
</style>
</head>
<body>
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="Play overlay">
    <div class="cta">
      <h2>SAPA JOURNEY</h2>
      <button id="playBtn" class="btn" aria-label="Play">Play</button>
      <p>One click to start</p>
    </div>
  </div>
  <div class="wrapper">
    <div class="topbar">
      <div class="title">
        <h1>SAPA JOURNEY â€¢ 8Ã—8</h1>
                 <div class="sub">fujky, hauky, kaja, luky, martin, lightning, tree</div>
      </div>
             <div class="stats">
                   <div class="stat">Score: <span id="score">0</span></div>
          <div class="stat">Time: <span id="timer">60</span>s</div>
          <div class="lives" id="lives">
            <span class="heart">â™¥</span>
            <span class="heart">â™¥</span>
            <span class="heart">â™¥</span>
          </div>
         <button id="superpowerBtn" class="btn superpower" style="display:none;" title="Explode all fujky pieces">
           <img src="carton.png" alt="carton" />
         </button>
         <button id="resetBtn" class="btn secondary" style="display:none;">Reset</button>
       </div>
    </div>

    <div id="boardWrap" class="board-wrap">
      <div class="legend" id="legend"></div>
      <div id="board" class="board" aria-label="Match-3 board"></div>
      <div id="fxLayer" class="fx-layer" aria-hidden="true"></div>
      <div id="radostOverlay" class="radost-overlay" aria-hidden="true">
        <img src="radost.png" alt="radost" class="radost-img"/>
      </div>
             <div class="footer">Click a tile, then an adjacent tile to swap.</div>
     </div>
   </div>
   
       <!-- Defeat overlay -->
    <div id="defeatOverlay" class="defeat-overlay">
      <div class="defeat-content">
        <h2>Game Over!</h2>
        <img src="sadkitten.gif" alt="Sad kitten" class="defeat-gif">
        <p>You ran out of lives!</p>
        <button id="restartBtn" class="btn">Try Again</button>
      </div>
    </div>
    
    <!-- Time-up overlay -->
    <div id="timeUpOverlay" class="time-up-overlay">
      <div class="time-up-content">
        <h2>Time's Up!</h2>
        <p>Your final score is: <span id="finalScore">0</span></p>
        <button id="timeUpRestartBtn" class="btn">Play Again</button>
      </div>
    </div>

<script>
(function () {
  const ROWS = 8;
  const COLS = 8;
  const TOTAL_CELLS = ROWS * COLS;

  const SYMBOLS = [
    { key: 'fujky',  img: 'fujky.png' },
    { key: 'hauky',  img: 'hauky.png' },
    { key: 'kaja',   img: 'kaja.png' },
    { key: 'luky',   img: 'luky.png' },
    { key: 'martin', img: 'martin.png' },
    { key: 'lightning', img: 'lightning.png' },
    { key: 'tree',   img: 'tree.png' },
  ];

  const boardEl = document.getElementById('board');
  const boardWrapEl = document.getElementById('boardWrap');
  const scoreEl = document.getElementById('score');
  const resetBtn = document.getElementById('resetBtn');
  const superpowerBtn = document.getElementById('superpowerBtn');
  const livesEl = document.getElementById('lives');
     const defeatOverlayEl = document.getElementById('defeatOverlay');
   const restartBtn = document.getElementById('restartBtn');
   const timeUpOverlayEl = document.getElementById('timeUpOverlay');
   const timeUpRestartBtn = document.getElementById('timeUpRestartBtn');
   const finalScoreEl = document.getElementById('finalScore');
   const timerEl = document.getElementById('timer');
   const legendEl = document.getElementById('legend');
   const overlayEl = document.getElementById('overlay');
   const playBtn = document.getElementById('playBtn');
   const fxLayerEl = document.getElementById('fxLayer');
   const radostOverlayEl = document.getElementById('radostOverlay');

           const fujkyIndex = SYMBOLS.findIndex(s => s.key === 'fujky');

  // --- Audio (generated, no assets) ---
  let audioCtx = null;
  function ensureAudio() {
    if (!audioCtx) {
      try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch {}
    }
    if (audioCtx && audioCtx.state === 'suspended') {
      audioCtx.resume?.();
    }
    return audioCtx;
  }
  function playToneSequence(tones) {
    const ctx = ensureAudio();
    if (!ctx) return;
    const now = ctx.currentTime + 0.01;
    const master = ctx.createGain();
    master.gain.value = 0.12;
    master.connect(ctx.destination);
    let t = now;
    for (const { freq, type = 'sine', dur = 0.12 } of tones) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, t);
      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(1.0, t + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, t + dur);
      osc.connect(gain).connect(master);
      osc.start(t);
      osc.stop(t + dur + 0.02);
      t += dur * 0.8;
    }
  }
  function playTadaa() {
    // Simple major triad arpeggio (C-E-G)
    playToneSequence([
      { freq: 261.63, type: 'sine', dur: 0.12 },
      { freq: 329.63, type: 'sine', dur: 0.12 },
      { freq: 392.00, type: 'sine', dur: 0.16 },
    ]);
    if (navigator.vibrate) navigator.vibrate(15);
  }
  function playMnam() {
    const ctx = ensureAudio();
    if (!ctx) return;
    const now = ctx.currentTime + 0.005;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(220, now);
    osc.frequency.exponentialRampToValueAtTime(95, now + 0.18);
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.9, now + 0.03);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);
    osc.connect(gain).connect(ctx.destination);
    osc.start(now);
    osc.stop(now + 0.24);
    if (navigator.vibrate) navigator.vibrate(8);
  }

  // --- Visual effects ---
     function spawnTextEffect(text, kind = 'tadaa') {
     if (!fxLayerEl) return;
     const el = document.createElement('div');
     el.className = `fx-text ${kind} ${kind === 'tadaa' ? 'large' : 'small'}`;
     el.textContent = text;
     fxLayerEl.appendChild(el);
     setTimeout(() => el.remove(), 800);
   }
   
   

  legendEl.innerHTML = SYMBOLS
    .map(s => `<span class="pill"><img class="icon" src="${s.img}" alt="${s.key}"><span style="opacity:.8">${s.key}</span></span>`)
    .join('');

  let board = new Array(TOTAL_CELLS).fill(0);
  let selectedIndex = null;
  let isBusy = false;
  let score = 0;
  let lives = 3;
  let lastMatchHadFourPlus = false;
  let hasSuperpower = false;
     let bgAudioEl = null;
   let radostAudioEl = null;
   let defeatAudioEl = null;
   let gameTimer = null;
   let timeLeft = 60;

  function idx(r, c) { return r * COLS + c; }
  function rowOf(i) { return Math.floor(i / COLS); }
  function colOf(i) { return i % COLS; }

     function randomSymbol() {
     return Math.floor(Math.random() * SYMBOLS.length);
   }
   
       function canFormMatch(val1, val2) {
      if (val1 === null || val2 === null) return false;
      if (val1 === val2) return true;
      return false;
    }

           function initBoardNoStartingMatches() {
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          let tries = 0;
          while (true) {
            const candidate = randomSymbol();
            board[idx(r, c)] = candidate;
            if (!createsMatchAt(r, c)) break;
            tries++;
            if (tries > 20) break;
          }
        }
      }
    }

     function createsMatchAt(r, c) {
     const value = board[idx(r, c)];
     const c1 = c - 1, c2 = c - 2;
     if (c1 >= 0 && c2 >= 0 &&
         canFormMatch(board[idx(r, c1)], value) && canFormMatch(board[idx(r, c2)], value)) return true;
     const r1 = r - 1, r2 = r - 2;
     if (r1 >= 0 && r2 >= 0 &&
         canFormMatch(board[idx(r1, c)], value) && canFormMatch(board[idx(r2, c)], value)) return true;
     return false;
   }

  function renderBoard(highlighted = new Set(), matched = new Set(), invalid = new Set()) {
    const busyClass = isBusy ? 'busy' : '';
    boardEl.innerHTML = '';
    for (let i = 0; i < TOTAL_CELLS; i++) {
      const cell = document.createElement('button');
      cell.className = `cell ${busyClass} ${highlighted.has(i) ? 'selected' : ''} ${matched.has(i) ? 'matched' : ''} ${invalid.has(i) ? 'invalid' : ''}`;
      cell.type = 'button';
      cell.disabled = isBusy;
             const v = board[i];
       if (v == null) {
         cell.textContent = '';
       } else {
         const img = document.createElement('img');
         img.className = 'icon';
         img.src = SYMBOLS[v].img;
         img.alt = SYMBOLS[v].key;
         cell.appendChild(img);
         // Add data-symbol attribute for CSS targeting
         cell.setAttribute('data-symbol', SYMBOLS[v].key);
       }
       cell.dataset.index = i;
       cell.setAttribute('aria-label', v == null ? 'empty' : SYMBOLS[v].key);
      cell.addEventListener('click', onCellClick);
      boardEl.appendChild(cell);
    }
  }

  function onCellClick(e) {
    if (isBusy) return;
    const i = Number(e.currentTarget.dataset.index);
    if (selectedIndex == null) {
      selectedIndex = i;
      renderBoard(new Set([i]));
      return;
    }
    if (i === selectedIndex) {
      selectedIndex = null;
      renderBoard();
      return;
    }
    if (!areAdjacent(i, selectedIndex)) {
      selectedIndex = i;
      renderBoard(new Set([i]));
      return;
    }
    attemptSwap(selectedIndex, i);
  }

  function areAdjacent(a, b) {
    const ra = rowOf(a), ca = colOf(a);
    const rb = rowOf(b), cb = colOf(b);
    const manhattan = Math.abs(ra - rb) + Math.abs(ca - cb);
    return manhattan === 1;
  }

  function swap(a, b) {
    const t = board[a];
    board[a] = board[b];
    board[b] = t;
  }

     function findAllMatches() {
     const matched = new Set();
     lastMatchHadFourPlus = false;

     // Check horizontal matches
     for (let r = 0; r < ROWS; r++) {
       let runStart = 0;
       for (let c = 1; c <= COLS; c++) {
         const prev = c - 1;
         const currVal = c < COLS ? board[idx(r, c)] : null;
         const prevVal = board[idx(r, prev)];
         
         // Check if current and previous values can form a match (including stars)
         if (c < COLS && canFormMatch(currVal, prevVal)) {
           continue;
         } else {
           const runEnd = prev;
           const runLen = runEnd - runStart + 1;
           if (prevVal != null && runLen >= 3) {
             for (let cc = runStart; cc <= runEnd; cc++) {
               matched.add(idx(r, cc));
             }
             if (runLen >= 4) lastMatchHadFourPlus = true;
           }
           runStart = c;
         }
       }
     }

     // Check vertical matches
     for (let c = 0; c < COLS; c++) {
       let runStart = 0;
       for (let r = 1; r <= ROWS; r++) {
         const prev = r - 1;
         const currVal = r < ROWS ? board[idx(r, c)] : null;
         const prevVal = board[idx(prev, c)];
         
         // Check if current and previous values can form a match (including stars)
         if (r < ROWS && canFormMatch(currVal, prevVal)) {
           continue;
         } else {
           const runEnd = prev;
           const runLen = runEnd - runStart + 1;
           if (prevVal != null && runLen >= 3) {
             for (let rr = runStart; rr <= runEnd; rr++) {
               matched.add(idx(rr, c));
             }
             if (runLen >= 4) lastMatchHadFourPlus = true;
           }
           runStart = r;
         }
       }
     }
     return matched;
   }

           function clearMatches(matched) {
      matched.forEach(i => {
        board[i] = null;
      });
    }
   

   
   

  function applyGravityAndRefill() {
    for (let c = 0; c < COLS; c++) {
      let writeRow = ROWS - 1;
      for (let r = ROWS - 1; r >= 0; r--) {
        const i = idx(r, c);
        if (board[i] != null) {
          board[idx(writeRow, c)] = board[i];
          if (writeRow !== r) board[i] = null;
          writeRow--;
        }
      }
                    for (let r = writeRow; r >= 0; r--) {
          board[idx(r, c)] = randomSymbol();
        }
    }
  }

  async function resolveBoardWithCascades() {
    while (true) {
      const matches = findAllMatches();
      if (matches.size === 0) break;
      // Effects: always TADAAA on a match; plus MÅ‡AM if any matched tile is fujky
      let matchedIncludesFujky = false;
      for (const i of matches) {
        if (board[i] === fujkyIndex) { matchedIncludesFujky = true; break; }
      }
      if (matchedIncludesFujky) {
        spawnTextEffect('MÅ‡AM!', 'mnam');
        playMnam();
      } else {
        spawnTextEffect('TADAAA!', 'tadaa');
        playTadaa();
      }
             if (lastMatchHadFourPlus) {
         // Show radost celebration briefly
                  if (radostOverlayEl) {
            radostOverlayEl.classList.add('show');
            setTimeout(() => radostOverlayEl.classList.remove('show'), 3000);
          }
          // Play radost celebration audio
          try {
            if (radostAudioEl) {
              radostAudioEl.currentTime = 0;
              radostAudioEl.play().catch(() => {});
            }
          } catch {}
         // Grant superpower for 4+ match
         hasSuperpower = true;
         if (superpowerBtn) {
           superpowerBtn.style.display = 'inline-block';
         }
       }
             renderBoard(new Set(), matches);
       await wait(180);
       
               clearMatches(matches);
        score += matches.size * 10;
      scoreEl.textContent = String(score);
      renderBoard();
      await wait(40);
      applyGravityAndRefill();
      renderBoard();
      await wait(120);
    }
  }

  async function attemptSwap(a, b) {
    isBusy = true;
    const highlighted = new Set([a, b]);
    swap(a, b);
    renderBoard(highlighted);
    await wait(140);
    const matches = findAllMatches();
         if (matches.size === 0) {
       swap(a, b);
       // Flash red on the attempted pair, then revert to normal
       const pair = new Set([a, b]);
       renderBoard(pair, new Set(), pair);
       await wait(180);
       renderBoard();
       
       // Lose a life for invalid move
       loseLife();
     } else {
      await resolveBoardWithCascades();
      renderBoard();
    }
    selectedIndex = null;
    isBusy = false;
    // Ensure buttons are re-enabled after busy phase
    renderBoard();
  }

     function wait(ms) {
     return new Promise(res => setTimeout(res, ms));
   }
   
   function startTimer() {
     timeLeft = 60;
     updateTimerDisplay();
     
     gameTimer = setInterval(() => {
       timeLeft--;
       updateTimerDisplay();
       
       if (timeLeft <= 0) {
         clearInterval(gameTimer);
         showTimeUpScreen();
       }
     }, 1000);
   }
   
   function updateTimerDisplay() {
     if (timerEl) {
       timerEl.textContent = timeLeft;
     }
   }
   
   function stopTimer() {
     if (gameTimer) {
       clearInterval(gameTimer);
       gameTimer = null;
     }
   }
   
   function showTimeUpScreen() {
     // Stop background music
     if (bgAudioEl) {
       bgAudioEl.pause();
       bgAudioEl.currentTime = 0;
     }
     
     // Update final score
     if (finalScoreEl) {
       finalScoreEl.textContent = score;
     }
     
     // Show time-up overlay
     if (timeUpOverlayEl) {
       timeUpOverlayEl.classList.add('show');
     }
   }
   
   function loseLife() {
     lives--;
     updateLivesDisplay();
     
     if (lives <= 0) {
       showDefeatScreen();
     }
   }
   
   function updateLivesDisplay() {
     if (!livesEl) return;
     const hearts = livesEl.querySelectorAll('.heart');
     console.log(`Found ${hearts.length} hearts, lives: ${lives}`);
     hearts.forEach((heart, index) => {
       if (index < lives) {
         heart.classList.remove('lost');
         console.log(`Heart ${index}: red`);
       } else {
         heart.classList.add('lost');
         console.log(`Heart ${index}: black`);
       }
     });
   }
   
   function showDefeatScreen() {
     // Stop background music
     if (bgAudioEl) {
       bgAudioEl.pause();
       bgAudioEl.currentTime = 0;
     }
     
     // Stop the timer
     stopTimer();
     
     // Play defeat audio
     try {
       if (defeatAudioEl) {
         defeatAudioEl.currentTime = 0;
         defeatAudioEl.play().catch(() => {});
       }
     } catch {}
     
     // Show defeat overlay
     if (defeatOverlayEl) {
       defeatOverlayEl.classList.add('show');
     }
   }
   
   function explodeAllFujky() {
     if (!hasSuperpower) return;
     
     // Find all fujky pieces
     const fujkyIndices = [];
     for (let i = 0; i < TOTAL_CELLS; i++) {
       if (board[i] === fujkyIndex) {
         fujkyIndices.push(i);
       }
     }
     
     if (fujkyIndices.length > 0) {
       // Clear all fujky pieces
       fujkyIndices.forEach(i => board[i] = null);
       
       // Add score for each exploded fujky
       score += fujkyIndices.length * 15;
       scoreEl.textContent = String(score);
       
       // Show explosion effect
       renderBoard(new Set(), new Set(), new Set(fujkyIndices));
       
       // Apply gravity and refill
       setTimeout(async () => {
         applyGravityAndRefill();
         renderBoard();
         
         // Check for cascading matches
         await resolveBoardWithCascades();
       }, 200);
       
       // Use up the superpower
       hasSuperpower = false;
       if (superpowerBtn) {
         superpowerBtn.style.display = 'none';
       }
     }
   }

     function startGame() {
     ensureAudio();
     
     // Stop defeat audio if it's playing
     if (defeatAudioEl) {
       defeatAudioEl.pause();
       defeatAudioEl.currentTime = 0;
     }
     
     score = 0;
     lives = 3;
     scoreEl.textContent = '0';
     selectedIndex = null;
     isBusy = false;
     hasSuperpower = false;
     initBoardNoStartingMatches();
     boardWrapEl.style.display = 'block';
     resetBtn.style.display = 'inline-block';
     if (superpowerBtn) superpowerBtn.style.display = 'none';
     if (overlayEl) overlayEl.classList.add('hidden');
     if (defeatOverlayEl) defeatOverlayEl.classList.remove('show');
     if (timeUpOverlayEl) timeUpOverlayEl.classList.remove('show');
     updateLivesDisplay();
     renderBoard();
     
     // Start the game timer
     startTimer();
    // Start/ensure background music
    try {
      if (!bgAudioEl) {
        bgAudioEl = new Audio('background.mp3');
        bgAudioEl.loop = true;
        bgAudioEl.volume = 0.35;
      }
            bgAudioEl.play().catch(() => {});
     } catch {}
            // Preload radost celebration audio
       try {
         if (!radostAudioEl) {
           radostAudioEl = new Audio('uhm-damn-that-shi-good.mp3');
           radostAudioEl.volume = 0.25;
         }
       } catch {}
       
       // Preload defeat audio
       try {
         if (!defeatAudioEl) {
           defeatAudioEl = new Audio('sad-meow-song.mp3');
           defeatAudioEl.volume = 0.4;
         }
       } catch {}
     }

  // One-click Play handlers
  if (playBtn) playBtn.addEventListener('click', startGame);
  if (overlayEl) overlayEl.addEventListener('click', (ev) => {
    // Allow clicking anywhere on the overlay to start
    if (ev.target === overlayEl) startGame();
  });
  // Keyboard shortcuts to start: Enter/Space
  document.addEventListener('keydown', (ev) => {
    if (!overlayEl || overlayEl.classList.contains('hidden')) return;
    if (ev.key === 'Enter' || ev.key === ' ') {
      ev.preventDefault();
      startGame();
    }
  });
           resetBtn.addEventListener('click', startGame);
    superpowerBtn.addEventListener('click', explodeAllFujky);
    restartBtn.addEventListener('click', startGame);
    timeUpRestartBtn.addEventListener('click', startGame);
})();
</script>
</body>
</html>